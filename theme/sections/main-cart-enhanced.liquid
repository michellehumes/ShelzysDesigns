{%- comment -%}
<!-- SHELZYS_DESIGNS: START main-cart-enhanced -->
  Enhanced Cart with:
  - Free shipping progress bar
  - Cart upsell section ("Complete Your Gift")
  - Better item display with personalization properties
<!-- SHELZYS_DESIGNS: END main-cart-enhanced -->
{%- endcomment -%}

<section class="cart-enhanced section-padding">
  <div class="container">
    <h1 class="cart-enhanced__title">Your Cart</h1>

    {%- if cart.item_count > 0 -%}

      {%- comment -%} === FREE SHIPPING PROGRESS BAR === {%- endcomment -%}
      {%- assign threshold = settings.free_shipping_threshold | default: 50 | times: 100 -%}
      {%- assign remaining = threshold | minus: cart.total_price -%}
      {%- assign progress = cart.total_price | times: 100.0 | divided_by: threshold -%}
      {%- if progress > 100 -%}{%- assign progress = 100 -%}{%- endif -%}

      <div class="cart-shipping-bar{% if remaining <= 0 %} cart-shipping-bar--achieved{% endif %}">
        <div class="shipping-bar__text">
          {%- if remaining > 0 -%}
            <span class="shipping-icon">üöö</span>
            You're <strong>{{ remaining | money }}</strong> away from <strong>FREE shipping!</strong>
          {%- else -%}
            <span class="shipping-icon">üéâ</span>
            <strong>You've unlocked FREE shipping!</strong>
          {%- endif -%}
        </div>
        <div class="shipping-bar__track">
          <div class="shipping-bar__fill" style="width: {{ progress }}%;"></div>
        </div>
      </div>

      <div class="cart-enhanced__layout">

        {%- comment -%} === CART ITEMS === {%- endcomment -%}
        <div class="cart-enhanced__items">
          <form action="/cart" method="post" id="cart-form">
            {%- for item in cart.items -%}
              <div class="cart-item-enhanced">
                <a href="{{ item.url }}" class="cart-item__image">
                  {%- if item.image -%}
                    <img src="{{ item.image | image_url: width: 150 }}" alt="{{ item.title | escape }}">
                  {%- else -%}
                    {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  {%- endif -%}
                </a>

                <div class="cart-item__details">
                  <h3 class="cart-item__title">
                    <a href="{{ item.url }}">{{ item.product.title }}</a>
                  </h3>

                  {%- if item.variant.title != 'Default Title' -%}
                    <p class="cart-item__variant">{{ item.variant.title }}</p>
                  {%- endif -%}

                  {%- comment -%} Personalization Properties {%- endcomment -%}
                  {%- if item.properties.size > 0 -%}
                    <div class="cart-item__props">
                      {%- for property in item.properties -%}
                        {%- unless property.last == blank -%}
                          <span class="prop-item">
                            <strong>{{ property.first }}:</strong> {{ property.last }}
                          </span>
                        {%- endunless -%}
                      {%- endfor -%}
                    </div>
                  {%- endif -%}

                  <p class="cart-item__unit-price">{{ item.price | money }} each</p>
                </div>

                <div class="cart-item__quantity">
                  <div class="qty-control">
                    <button type="button" class="qty-btn" onclick="updateQty({{ forloop.index }}, -1)">‚àí</button>
                    <input
                      type="number"
                      name="updates[]"
                      value="{{ item.quantity }}"
                      min="0"
                      data-line="{{ forloop.index }}"
                      class="qty-input"
                    >
                    <button type="button" class="qty-btn" onclick="updateQty({{ forloop.index }}, 1)">+</button>
                  </div>
                </div>

                <div class="cart-item__total">
                  {{ item.final_line_price | money }}
                </div>

                <a href="/cart/change?line={{ forloop.index }}&quantity=0" class="cart-item__remove" aria-label="Remove">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5">
                    <line x1="4" y1="4" x2="14" y2="14"></line>
                    <line x1="14" y1="4" x2="4" y2="14"></line>
                  </svg>
                </a>
              </div>
            {%- endfor -%}

            <button type="submit" name="update" class="btn btn-secondary cart-update-btn">Update Cart</button>
          </form>
        </div>

        {%- comment -%} === CART SIDEBAR === {%- endcomment -%}
        <div class="cart-enhanced__sidebar">

          {%- comment -%} Upsell Section {%- endcomment -%}
          {%- if settings.enable_cart_upsell -%}
            <div class="cart-upsell-section">
              <h3 class="cart-upsell__title">
                <span>üéÅ</span> Complete Your Gift
              </h3>

              {%- assign upsell_collection = collections[settings.upsell_collection] -%}
              {%- if upsell_collection.products.size > 0 -%}
                <div class="cart-upsell__items">
                  {%- for product in upsell_collection.products limit: 2 -%}
                    <div class="upsell-item">
                      <a href="{{ product.url }}" class="upsell-item__image">
                        <img src="{{ product.featured_image | image_url: width: 80 }}" alt="{{ product.title }}">
                      </a>
                      <div class="upsell-item__info">
                        <p class="upsell-item__title">{{ product.title | truncate: 30 }}</p>
                        <p class="upsell-item__price">{{ product.price | money }}</p>
                      </div>
                      <button
                        class="upsell-item__add"
                        data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                        onclick="quickAddToCart({{ product.selected_or_first_available_variant.id }})"
                      >
                        Add
                      </button>
                    </div>
                  {%- endfor -%}
                </div>
              {%- else -%}
                <p class="cart-upsell__text">
                  {{ settings.upsell_message | default: 'Ordering for your bridal party? Check out our bundle sets for bulk savings!' }}
                </p>
                <a href="/collections/bridal-party-sets" class="cart-upsell__link">Shop Bundle Sets ‚Üí</a>
              {%- endif -%}
            </div>
          {%- endif -%}

          {%- comment -%} Order Summary {%- endcomment -%}
          <div class="cart-summary">
            <h3 class="cart-summary__title">Order Summary</h3>

            <div class="cart-summary__row">
              <span>Subtotal</span>
              <span>{{ cart.total_price | money }}</span>
            </div>

            <div class="cart-summary__row cart-summary__shipping">
              <span>Shipping</span>
              <span>{%- if remaining <= 0 -%}FREE{%- else -%}Calculated at checkout{%- endif -%}</span>
            </div>

            <div class="cart-summary__row cart-summary__total">
              <span>Estimated Total</span>
              <span>{{ cart.total_price | money }}</span>
            </div>

            <form action="/cart" method="post">
              <button type="submit" name="checkout" class="btn btn-primary btn-lg cart-checkout-btn" data-shelzys="begin-checkout">
                Checkout
              </button>
            </form>

            <p class="cart-summary__note">
              Taxes calculated at checkout. Free shipping on orders $50+.
            </p>

            <div class="cart-summary__trust">
              <span>üîí Secure Checkout</span>
              <span>üí≥ All major cards accepted</span>
            </div>
          </div>
        </div>
      </div>

    {%- else -%}
      <div class="cart-empty">
        <div class="cart-empty__icon">üõí</div>
        <h2>Your cart is empty</h2>
        <p>Ready to create something special?</p>
        <a href="/collections/best-sellers" class="btn btn-primary">Shop Best Sellers</a>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
/* SHELZYS_DESIGNS: START cart-enhanced-styles */
.cart-enhanced__title {
  text-align: center;
  margin-bottom: 30px;
}

/* Shipping Bar */
.cart-shipping-bar {
  max-width: 700px;
  margin: 0 auto 30px;
  background: #F7F4EF;
  padding: 16px 20px;
  border-radius: 12px;
  text-align: center;
}

.cart-shipping-bar--achieved {
  background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
}

.shipping-bar__text {
  font-size: 15px;
  margin-bottom: 10px;
}

.shipping-icon {
  margin-right: 6px;
}

.shipping-bar__track {
  height: 8px;
  background: #E0E0E0;
  border-radius: 4px;
  overflow: hidden;
}

.shipping-bar__fill {
  height: 100%;
  background: linear-gradient(90deg, #9CAE8C 0%, #7C9F8C 100%);
  border-radius: 4px;
  transition: width 0.4s ease;
}

/* Layout */
.cart-enhanced__layout {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 40px;
  align-items: start;
}

/* Cart Items */
.cart-item-enhanced {
  display: grid;
  grid-template-columns: 100px 1fr auto 100px 40px;
  gap: 20px;
  align-items: center;
  padding: 20px 0;
  border-bottom: 1px solid #F0F0F0;
}

.cart-item__image {
  border-radius: 8px;
  overflow: hidden;
  background: #F7F4EF;
}

.cart-item__image img {
  width: 100%;
  height: auto;
  display: block;
}

.cart-item__title {
  font-size: 15px;
  font-weight: 600;
  margin: 0 0 4px;
}

.cart-item__title a {
  color: #111;
  text-decoration: none;
}

.cart-item__variant {
  font-size: 13px;
  color: #666;
  margin: 0 0 6px;
}

.cart-item__props {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 6px;
}

.prop-item {
  display: inline-block;
  background: #F7F4EF;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 11px;
  color: #555;
}

.cart-item__unit-price {
  font-size: 13px;
  color: #888;
  margin: 0;
}

.qty-control {
  display: flex;
  border: 1px solid #E0E0E0;
  border-radius: 6px;
  overflow: hidden;
}

.qty-btn {
  width: 36px;
  height: 36px;
  background: #F7F4EF;
  border: none;
  font-size: 18px;
  cursor: pointer;
}

.qty-btn:hover {
  background: #E8E5E0;
}

.qty-input {
  width: 48px;
  height: 36px;
  border: none;
  border-left: 1px solid #E0E0E0;
  border-right: 1px solid #E0E0E0;
  text-align: center;
  font-size: 14px;
}

.cart-item__total {
  font-size: 16px;
  font-weight: 700;
  text-align: right;
}

.cart-item__remove {
  color: #999;
  transition: color 0.2s;
}

.cart-item__remove:hover {
  color: #C44;
}

.cart-update-btn {
  margin-top: 16px;
}

/* Sidebar */
.cart-enhanced__sidebar {
  position: sticky;
  top: 100px;
}

/* Upsell */
.cart-upsell-section {
  background: #FFFCF5;
  border: 1px dashed #D4AF37;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.cart-upsell__title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  margin: 0 0 14px;
}

.cart-upsell__items {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.upsell-item {
  display: flex;
  align-items: center;
  gap: 12px;
  background: #FFF;
  padding: 10px;
  border-radius: 8px;
}

.upsell-item__image {
  width: 50px;
  height: 50px;
  border-radius: 6px;
  overflow: hidden;
  flex-shrink: 0;
}

.upsell-item__image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.upsell-item__info {
  flex: 1;
  min-width: 0;
}

.upsell-item__title {
  font-size: 13px;
  font-weight: 500;
  margin: 0 0 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.upsell-item__price {
  font-size: 12px;
  color: #666;
  margin: 0;
}

.upsell-item__add {
  background: #9CAE8C;
  color: #FFF;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

.upsell-item__add:hover {
  background: #7C9F8C;
}

.cart-upsell__text {
  font-size: 14px;
  color: #666;
  margin: 0 0 10px;
}

.cart-upsell__link {
  font-size: 14px;
  font-weight: 600;
  color: #9CAE8C;
}

/* Summary */
.cart-summary {
  background: #F7F4EF;
  padding: 24px;
  border-radius: 12px;
}

.cart-summary__title {
  font-size: 18px;
  margin: 0 0 16px;
}

.cart-summary__row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  font-size: 14px;
  border-bottom: 1px solid #E8E5E0;
}

.cart-summary__total {
  font-size: 18px;
  font-weight: 700;
  border-bottom: none;
  padding-top: 14px;
}

.cart-checkout-btn {
  width: 100%;
  margin-top: 16px;
}

.cart-summary__note {
  font-size: 12px;
  color: #888;
  text-align: center;
  margin: 12px 0;
}

.cart-summary__trust {
  display: flex;
  justify-content: center;
  gap: 16px;
  font-size: 12px;
  color: #666;
}

/* Empty Cart */
.cart-empty {
  text-align: center;
  padding: 80px 20px;
}

.cart-empty__icon {
  font-size: 60px;
  margin-bottom: 16px;
}

.cart-empty h2 {
  margin: 0 0 8px;
}

.cart-empty p {
  color: #666;
  margin-bottom: 24px;
}

/* Responsive */
@media (max-width: 968px) {
  .cart-enhanced__layout {
    grid-template-columns: 1fr;
  }

  .cart-enhanced__sidebar {
    position: static;
  }

  .cart-item-enhanced {
    grid-template-columns: 80px 1fr 40px;
    gap: 12px;
  }

  .cart-item__quantity {
    grid-column: 2;
  }

  .cart-item__total {
    grid-column: 2;
    text-align: left;
    margin-top: -10px;
  }

  .cart-item__remove {
    grid-row: 1 / 3;
  }
}
/* SHELZYS_DESIGNS: END cart-enhanced-styles */
</style>

<script>
/* SHELZYS_DESIGNS: START cart-enhanced-js */
function updateQty(line, delta) {
  const input = document.querySelector(`input[data-line="${line}"]`);
  if (!input) return;
  let val = parseInt(input.value) || 1;
  val = Math.max(0, val + delta);
  input.value = val;
}

async function quickAddToCart(variantId) {
  try {
    const response = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: variantId, quantity: 1 })
    });

    if (response.ok) {
      window.location.reload();
    }
  } catch (e) {
    console.error('Failed to add item', e);
  }
}
/* SHELZYS_DESIGNS: END cart-enhanced-js */
</script>

{% schema %}
{
  "name": "Cart Enhanced",
  "tag": "section",
  "class": "section-cart-enhanced"
}
{% endschema %}
