{% comment %}
================================================================================
SHELZY'S DESIGNS - OPTIMIZED IMAGE SNIPPET
Version: 2.0.0
Last Updated: 2024-12
================================================================================
Performance-optimized image rendering with:
- Responsive srcset
- Lazy loading (below fold)
- Modern formats (AVIF/WebP via Shopify CDN)
- Proper alt text

Usage:
{% render 'optimized-image',
  image: image,
  alt: 'Description',
  sizes: '(min-width: 768px) 50vw, 100vw',
  widths: '400, 600, 800, 1000, 1200',
  loading: 'lazy',
  fetchpriority: 'auto',
  class: 'my-image-class',
  aspect_ratio: '1/1'
%}
================================================================================
{% endcomment %}

{%- liquid
  assign loading = loading | default: 'lazy'
  assign fetchpriority = fetchpriority | default: 'auto'
  assign sizes = sizes | default: '100vw'
  assign widths = widths | default: '400, 600, 800, 1000, 1200, 1600'
  assign img_alt = alt | default: image.alt | default: ''
  assign img_class = class | default: ''
  assign aspect = aspect_ratio | default: nil
-%}

{%- if image != blank -%}
  <picture>
    {%- comment -%} AVIF format (best compression, modern browsers) {%- endcomment -%}
    <source
      type="image/avif"
      srcset="{%- for width in widths -%}
        {%- assign w = width | strip -%}
        {{ image | image_url: width: w, format: 'jpg' }}&format=avif {{ w }}w{%- unless forloop.last -%}, {%- endunless -%}
      {%- endfor -%}"
      sizes="{{ sizes }}"
    >

    {%- comment -%} WebP format (good compression, wide support) {%- endcomment -%}
    <source
      type="image/webp"
      srcset="{%- for width in widths -%}
        {%- assign w = width | strip -%}
        {{ image | image_url: width: w, format: 'webp' }} {{ w }}w{%- unless forloop.last -%}, {%- endunless -%}
      {%- endfor -%}"
      sizes="{{ sizes }}"
    >

    {%- comment -%} Fallback JPG/PNG {%- endcomment -%}
    <img
      src="{{ image | image_url: width: 800 }}"
      srcset="{%- for width in widths -%}
        {%- assign w = width | strip -%}
        {{ image | image_url: width: w }} {{ w }}w{%- unless forloop.last -%}, {%- endunless -%}
      {%- endfor -%}"
      sizes="{{ sizes }}"
      alt="{{ img_alt | escape }}"
      loading="{{ loading }}"
      {%- if fetchpriority != 'auto' %}fetchpriority="{{ fetchpriority }}"{% endif %}
      class="{{ img_class }}"
      {%- if aspect %}style="aspect-ratio: {{ aspect }}; object-fit: cover;"{% endif %}
      width="{{ image.width }}"
      height="{{ image.height }}"
      decoding="async"
    >
  </picture>
{%- else -%}
  {%- comment -%} Placeholder for missing images {%- endcomment -%}
  <div
    class="sz-image-placeholder {{ img_class }}"
    {%- if aspect %}style="aspect-ratio: {{ aspect }};"{% endif %}
    role="img"
    aria-label="No image available"
  >
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" aria-hidden="true">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
  </div>
{%- endif -%}
