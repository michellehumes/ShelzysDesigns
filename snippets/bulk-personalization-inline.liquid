{%- comment -%}
================================================================================
SHELZY'S DESIGNS - INLINE BULK PERSONALIZATION
Version: 1.0.0
================================================================================
Inline form for ordering multiple personalized bottles at once (5-20).
Add to product page for bundle/group products.

Usage: {% render 'bulk-personalization-inline', product: product, min_qty: 5, max_qty: 20 %}

Revenue Impact: Increases AOV by making bulk personalization frictionless.
================================================================================
{%- endcomment -%}

{% assign min_qty = min_qty | default: 5 %}
{% assign max_qty = max_qty | default: 20 %}

<div class="sz-bulk-inline" id="szBulkInline">
  <div class="sz-bulk-inline-header">
    <div class="sz-bulk-inline-toggle">
      <button type="button" class="sz-bulk-toggle-btn sz-bulk-single active" data-mode="single">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="7" r="4"/>
          <path d="M5.5 21a8.5 8.5 0 0 1 13 0"/>
        </svg>
        Single Bottle
      </button>
      <button type="button" class="sz-bulk-toggle-btn sz-bulk-multi" data-mode="bulk">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="7" r="4"/>
          <circle cx="17" cy="7" r="4"/>
          <path d="M3 21a7 7 0 0 1 7-7"/>
          <path d="M14 21a7 7 0 0 1 7-7"/>
        </svg>
        Multiple Bottles ({{ min_qty }}-{{ max_qty }})
      </button>
    </div>
  </div>

  {%- comment -%} Single Bottle Mode {%- endcomment -%}
  <div class="sz-bulk-mode sz-bulk-mode-single active" id="szBulkModeSingle">
    <div class="sz-bulk-single-form">
      <label for="single-name" class="sz-bulk-label">
        Personalization Name
        <span class="sz-bulk-required">*</span>
      </label>
      <input
        type="text"
        id="single-name"
        name="properties[Name]"
        class="sz-bulk-input"
        placeholder="Enter name (e.g., Sarah)"
        maxlength="20"
        required
      >
      <span class="sz-bulk-char-count"><span id="singleCharCount">0</span>/20 characters</span>
    </div>
  </div>

  {%- comment -%} Bulk Mode {%- endcomment -%}
  <div class="sz-bulk-mode sz-bulk-mode-bulk" id="szBulkModeBulk">
    <div class="sz-bulk-quantity-selector">
      <label class="sz-bulk-label">How many bottles?</label>
      <div class="sz-bulk-qty-buttons">
        {% for i in (min_qty..max_qty) %}
          <button type="button" class="sz-bulk-qty-btn {% if i == min_qty %}active{% endif %}" data-qty="{{ i }}">{{ i }}</button>
        {% endfor %}
        <button type="button" class="sz-bulk-qty-btn sz-bulk-qty-more">{{ max_qty }}+</button>
      </div>
      <p class="sz-bulk-qty-note">
        Need more than {{ max_qty }}? <a href="/pages/bulk-orders">Request a bulk quote</a>
      </p>
    </div>

    <div class="sz-bulk-names-section">
      <div class="sz-bulk-names-header">
        <label class="sz-bulk-label">Enter names for each bottle</label>
        <button type="button" class="sz-bulk-names-paste" id="szPasteNames">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
          </svg>
          Paste List
        </button>
      </div>

      <div class="sz-bulk-names-grid" id="szBulkNamesGrid">
        <!-- Name inputs populated by JavaScript -->
      </div>

      <div class="sz-bulk-names-actions">
        <button type="button" class="sz-bulk-clear-all" id="szClearAllNames">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          Clear All
        </button>
        <span class="sz-bulk-names-count">
          <span id="szFilledCount">0</span> of <span id="szTotalCount">{{ min_qty }}</span> names entered
        </span>
      </div>
    </div>

    {%- comment -%} Bulk Discount Message {%- endcomment -%}
    <div class="sz-bulk-savings" id="szBulkSavings">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
        <line x1="9" y1="9" x2="9.01" y2="9"/>
        <line x1="15" y1="9" x2="15.01" y2="9"/>
      </svg>
      <span id="szSavingsText">You're saving 10% on this order!</span>
    </div>

    {%- comment -%} Hidden inputs for form submission {%- endcomment -%}
    <input type="hidden" name="properties[Order Type]" value="Bulk" id="szBulkOrderType" disabled>
    <input type="hidden" name="properties[Names List]" value="" id="szBulkNamesList" disabled>
    <input type="hidden" name="properties[Quantity]" value="{{ min_qty }}" id="szBulkQuantity" disabled>
  </div>
</div>

{%- comment -%} Paste Modal {%- endcomment -%}
<div class="sz-bulk-paste-modal" id="szPasteModal" style="display: none;">
  <div class="sz-bulk-paste-content">
    <div class="sz-bulk-paste-header">
      <h3>Paste Name List</h3>
      <button type="button" class="sz-bulk-paste-close" id="szPasteClose">&times;</button>
    </div>
    <p class="sz-bulk-paste-instructions">Paste your list of names below. Each name should be on a new line or separated by commas.</p>
    <textarea id="szPasteTextarea" class="sz-bulk-paste-textarea" placeholder="Sarah&#10;Emily&#10;Jessica&#10;Amanda"></textarea>
    <div class="sz-bulk-paste-actions">
      <button type="button" class="sz-bulk-paste-cancel" id="szPasteCancel">Cancel</button>
      <button type="button" class="sz-bulk-paste-apply" id="szPasteApply">Apply Names</button>
    </div>
  </div>
</div>

<style>
  .sz-bulk-inline {
    margin: 20px 0;
    border: 1px solid #E8E4DE;
    border-radius: 12px;
    background: #FAF9F6;
    padding: 20px;
  }

  .sz-bulk-inline-header {
    margin-bottom: 20px;
  }

  .sz-bulk-inline-toggle {
    display: flex;
    gap: 8px;
    background: #FFFFFF;
    border-radius: 8px;
    padding: 4px;
    border: 1px solid #E8E4DE;
  }

  .sz-bulk-toggle-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    background: transparent;
    border: none;
    border-radius: 6px;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 13px;
    font-weight: 500;
    color: var(--sz-gray, #6B7280);
    cursor: pointer;
    transition: all 0.2s;
  }

  .sz-bulk-toggle-btn:hover {
    color: var(--sz-charcoal, #2B2B2B);
  }

  .sz-bulk-toggle-btn.active {
    background: var(--sz-primary-dark, #4E5F4A);
    color: #FFFFFF;
  }

  .sz-bulk-mode {
    display: none;
  }

  .sz-bulk-mode.active {
    display: block;
  }

  .sz-bulk-label {
    display: block;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    font-weight: 600;
    color: var(--sz-charcoal, #2B2B2B);
    margin-bottom: 8px;
  }

  .sz-bulk-required {
    color: var(--sz-error, #DC2626);
  }

  .sz-bulk-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #E8E4DE;
    border-radius: 8px;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 15px;
    background: #FFFFFF;
    transition: border-color 0.2s;
  }

  .sz-bulk-input:focus {
    outline: none;
    border-color: var(--sz-primary, #8BAA88);
  }

  .sz-bulk-char-count {
    display: block;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 12px;
    color: var(--sz-gray, #6B7280);
    margin-top: 6px;
    text-align: right;
  }

  /* Quantity Selector */
  .sz-bulk-quantity-selector {
    margin-bottom: 20px;
  }

  .sz-bulk-qty-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
  }

  .sz-bulk-qty-btn {
    min-width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #FFFFFF;
    border: 2px solid #E8E4DE;
    border-radius: 8px;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    font-weight: 600;
    color: var(--sz-charcoal, #2B2B2B);
    cursor: pointer;
    transition: all 0.2s;
  }

  .sz-bulk-qty-btn:hover {
    border-color: var(--sz-primary, #8BAA88);
  }

  .sz-bulk-qty-btn.active {
    background: var(--sz-primary-dark, #4E5F4A);
    border-color: var(--sz-primary-dark, #4E5F4A);
    color: #FFFFFF;
  }

  .sz-bulk-qty-more {
    background: #F5F2ED;
    color: var(--sz-gray, #6B7280);
    font-size: 12px;
    min-width: 50px;
  }

  .sz-bulk-qty-note {
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 12px;
    color: var(--sz-gray, #6B7280);
    margin: 0;
  }

  .sz-bulk-qty-note a {
    color: var(--sz-primary-dark, #4E5F4A);
  }

  /* Names Grid */
  .sz-bulk-names-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #E8E4DE;
  }

  .sz-bulk-names-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .sz-bulk-names-paste {
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 13px;
    color: var(--sz-primary-dark, #4E5F4A);
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 6px;
    transition: background 0.2s;
  }

  .sz-bulk-names-paste:hover {
    background: rgba(139, 170, 136, 0.1);
  }

  .sz-bulk-names-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 12px;
  }

  @media (max-width: 500px) {
    .sz-bulk-names-grid {
      grid-template-columns: 1fr;
    }
  }

  .sz-bulk-name-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sz-bulk-name-num {
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 12px;
    font-weight: 600;
    color: var(--sz-primary-dark, #4E5F4A);
    min-width: 24px;
  }

  .sz-bulk-name-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #E8E4DE;
    border-radius: 6px;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    background: #FFFFFF;
    transition: border-color 0.2s;
  }

  .sz-bulk-name-input:focus {
    outline: none;
    border-color: var(--sz-primary, #8BAA88);
  }

  .sz-bulk-name-input.filled {
    border-color: var(--sz-primary, #8BAA88);
    background: linear-gradient(135deg, #F8FAF8 0%, #FFFFFF 100%);
  }

  .sz-bulk-names-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sz-bulk-clear-all {
    display: flex;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 12px;
    color: var(--sz-gray, #6B7280);
    cursor: pointer;
    opacity: 0.7;
  }

  .sz-bulk-clear-all:hover {
    opacity: 1;
  }

  .sz-bulk-names-count {
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 13px;
    color: var(--sz-gray, #6B7280);
  }

  /* Savings Message */
  .sz-bulk-savings {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
    padding: 12px 16px;
    background: linear-gradient(135deg, #F0F5F0 0%, #E8F0E8 100%);
    border-radius: 8px;
    border: 1px solid #C7D3C5;
  }

  .sz-bulk-savings svg {
    color: var(--sz-primary-dark, #4E5F4A);
    flex-shrink: 0;
  }

  .sz-bulk-savings span {
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    font-weight: 500;
    color: var(--sz-primary-dark, #4E5F4A);
  }

  /* Paste Modal */
  .sz-bulk-paste-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .sz-bulk-paste-content {
    background: #FFFFFF;
    border-radius: 12px;
    max-width: 400px;
    width: 100%;
    padding: 24px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  }

  .sz-bulk-paste-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .sz-bulk-paste-header h3 {
    font-family: var(--sz-font-heading, 'Playfair Display', Georgia, serif);
    font-size: 20px;
    font-weight: 600;
    color: var(--sz-charcoal, #2B2B2B);
    margin: 0;
  }

  .sz-bulk-paste-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--sz-gray, #6B7280);
    cursor: pointer;
    padding: 4px 8px;
    line-height: 1;
  }

  .sz-bulk-paste-instructions {
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    color: var(--sz-gray, #6B7280);
    margin: 0 0 16px 0;
    line-height: 1.5;
  }

  .sz-bulk-paste-textarea {
    width: 100%;
    height: 150px;
    padding: 12px;
    border: 1px solid #E8E4DE;
    border-radius: 8px;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    resize: vertical;
    margin-bottom: 16px;
  }

  .sz-bulk-paste-textarea:focus {
    outline: none;
    border-color: var(--sz-primary, #8BAA88);
  }

  .sz-bulk-paste-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .sz-bulk-paste-cancel {
    padding: 10px 20px;
    background: #F5F2ED;
    border: none;
    border-radius: 6px;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    font-weight: 500;
    color: var(--sz-charcoal, #2B2B2B);
    cursor: pointer;
  }

  .sz-bulk-paste-apply {
    padding: 10px 20px;
    background: var(--sz-primary-dark, #4E5F4A);
    border: none;
    border-radius: 6px;
    font-family: var(--sz-font-body, 'Inter', sans-serif);
    font-size: 14px;
    font-weight: 500;
    color: #FFFFFF;
    cursor: pointer;
  }
</style>

<script>
(function() {
  var minQty = {{ min_qty }};
  var maxQty = {{ max_qty }};
  var currentQty = minQty;
  var currentMode = 'single';

  // Elements
  var container = document.getElementById('szBulkInline');
  var modeSingle = document.getElementById('szBulkModeSingle');
  var modeBulk = document.getElementById('szBulkModeBulk');
  var namesGrid = document.getElementById('szBulkNamesGrid');
  var pasteModal = document.getElementById('szPasteModal');
  var orderTypeInput = document.getElementById('szBulkOrderType');
  var namesListInput = document.getElementById('szBulkNamesList');
  var quantityInput = document.getElementById('szBulkQuantity');

  // Toggle mode buttons
  container.querySelectorAll('.sz-bulk-toggle-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var mode = this.dataset.mode;
      setMode(mode);
    });
  });

  function setMode(mode) {
    currentMode = mode;
    container.querySelectorAll('.sz-bulk-toggle-btn').forEach(function(b) {
      b.classList.toggle('active', b.dataset.mode === mode);
    });
    modeSingle.classList.toggle('active', mode === 'single');
    modeBulk.classList.toggle('active', mode === 'bulk');

    // Enable/disable hidden inputs
    orderTypeInput.disabled = mode === 'single';
    namesListInput.disabled = mode === 'single';
    quantityInput.disabled = mode === 'single';

    // Enable/disable single name input
    var singleInput = document.getElementById('single-name');
    singleInput.disabled = mode === 'bulk';
    singleInput.required = mode === 'single';

    if (mode === 'bulk') {
      renderNameInputs(currentQty);
    }
  }

  // Quantity buttons
  container.querySelectorAll('.sz-bulk-qty-btn:not(.sz-bulk-qty-more)').forEach(function(btn) {
    btn.addEventListener('click', function() {
      container.querySelectorAll('.sz-bulk-qty-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      this.classList.add('active');
      currentQty = parseInt(this.dataset.qty);
      quantityInput.value = currentQty;
      document.getElementById('szTotalCount').textContent = currentQty;
      renderNameInputs(currentQty);
      updateSavings();
    });
  });

  // More button - redirect to bulk page
  container.querySelector('.sz-bulk-qty-more').addEventListener('click', function() {
    window.location.href = '/pages/bulk-orders';
  });

  function renderNameInputs(qty) {
    var html = '';
    for (var i = 1; i <= qty; i++) {
      html += '<div class="sz-bulk-name-row">' +
        '<span class="sz-bulk-name-num">' + i + '.</span>' +
        '<input type="text" class="sz-bulk-name-input" data-index="' + i + '" placeholder="Name ' + i + '" maxlength="20">' +
      '</div>';
    }
    namesGrid.innerHTML = html;

    // Add event listeners
    namesGrid.querySelectorAll('.sz-bulk-name-input').forEach(function(input) {
      input.addEventListener('input', function() {
        this.classList.toggle('filled', this.value.trim() !== '');
        updateNamesList();
        updateFilledCount();
      });
    });

    updateFilledCount();
  }

  function updateFilledCount() {
    var filled = namesGrid.querySelectorAll('.sz-bulk-name-input.filled').length;
    document.getElementById('szFilledCount').textContent = filled;
  }

  function updateNamesList() {
    var names = [];
    namesGrid.querySelectorAll('.sz-bulk-name-input').forEach(function(input) {
      if (input.value.trim()) {
        names.push(input.value.trim());
      }
    });
    namesListInput.value = names.join(' | ');
  }

  function updateSavings() {
    var savingsText = document.getElementById('szSavingsText');
    var discount = 0;
    if (currentQty >= 5 && currentQty <= 9) discount = 10;
    else if (currentQty >= 10 && currentQty <= 14) discount = 15;
    else if (currentQty >= 15) discount = 20;

    savingsText.textContent = discount > 0
      ? "You're saving " + discount + "% on this order!"
      : "Add more bottles to unlock discounts!";
  }

  // Clear all
  document.getElementById('szClearAllNames').addEventListener('click', function() {
    namesGrid.querySelectorAll('.sz-bulk-name-input').forEach(function(input) {
      input.value = '';
      input.classList.remove('filled');
    });
    updateNamesList();
    updateFilledCount();
  });

  // Paste modal
  document.getElementById('szPasteNames').addEventListener('click', function() {
    pasteModal.style.display = 'flex';
    document.getElementById('szPasteTextarea').focus();
  });

  document.getElementById('szPasteClose').addEventListener('click', closePasteModal);
  document.getElementById('szPasteCancel').addEventListener('click', closePasteModal);

  function closePasteModal() {
    pasteModal.style.display = 'none';
    document.getElementById('szPasteTextarea').value = '';
  }

  document.getElementById('szPasteApply').addEventListener('click', function() {
    var text = document.getElementById('szPasteTextarea').value;
    var names = text.split(/[\n,]+/).map(function(n) { return n.trim(); }).filter(Boolean);

    if (names.length > maxQty) {
      alert('Maximum ' + maxQty + ' names allowed. For larger orders, please request a bulk quote.');
      names = names.slice(0, maxQty);
    }

    // Adjust quantity if needed
    if (names.length > currentQty && names.length >= minQty) {
      currentQty = names.length;
      quantityInput.value = currentQty;
      document.getElementById('szTotalCount').textContent = currentQty;
      renderNameInputs(currentQty);

      // Update active qty button
      container.querySelectorAll('.sz-bulk-qty-btn').forEach(function(b) {
        b.classList.toggle('active', parseInt(b.dataset.qty) === currentQty);
      });
    }

    // Fill in names
    var inputs = namesGrid.querySelectorAll('.sz-bulk-name-input');
    names.forEach(function(name, i) {
      if (inputs[i]) {
        inputs[i].value = name;
        inputs[i].classList.add('filled');
      }
    });

    updateNamesList();
    updateFilledCount();
    updateSavings();
    closePasteModal();
  });

  // Single name character count
  var singleNameInput = document.getElementById('single-name');
  singleNameInput.addEventListener('input', function() {
    document.getElementById('singleCharCount').textContent = this.value.length;
  });

  // Initialize
  renderNameInputs(minQty);
  updateSavings();
})();
</script>
