{% comment %}
================================================================================
SHELZY'S DESIGNS - CART GIFT MESSAGE
Version: 2.0.0
Last Updated: 2024-12
================================================================================
Optional gift message field for cart.
Stores message in cart note for order fulfillment.

Revenue Impact: Gift messaging signals gift intent,
increases perceived value and reduces cart abandonment.

Usage: {% render 'cart-gift-message' %}
================================================================================
{% endcomment %}

{%- liquid
  assign show_gift_message = settings.show_cart_gift_message | default: true
  assign max_length = 200
-%}

{%- if show_gift_message -%}
<div class="sz-gift-message">
  <details class="sz-gift-message__details">
    <summary class="sz-gift-message__toggle">
      <span class="sz-gift-message__toggle-content">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <polyline points="20 12 20 22 4 22 4 12"/>
          <rect x="2" y="7" width="20" height="5"/>
          <line x1="12" y1="22" x2="12" y2="7"/>
          <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/>
          <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>
        </svg>
        <span>Add a Gift Message</span>
        <span class="sz-gift-message__free">Free</span>
      </span>
      <svg class="sz-gift-message__chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    </summary>

    <div class="sz-gift-message__content">
      <div class="sz-gift-message__field">
        <label for="szGiftMessage" class="sz-gift-message__label">
          Your message (optional)
        </label>
        <textarea
          id="szGiftMessage"
          name="note"
          class="sz-gift-message__textarea"
          placeholder="Write a heartfelt message for the recipient..."
          maxlength="{{ max_length }}"
          rows="3"
        >{{ cart.note }}</textarea>
        <div class="sz-gift-message__footer">
          <span class="sz-gift-message__counter">
            <span id="szGiftMessageCount">{{ cart.note.size | default: 0 }}</span>/{{ max_length }}
          </span>
          <span class="sz-gift-message__hint">
            We'll include a printed card with your order
          </span>
        </div>
      </div>

      <div class="sz-gift-message__options">
        <label class="sz-gift-message__checkbox">
          <input type="checkbox" name="attributes[is_gift]" value="Yes" {% if cart.attributes.is_gift == 'Yes' %}checked{% endif %}>
          <span class="sz-gift-message__checkmark"></span>
          <span>This is a gift - hide prices from packing slip</span>
        </label>
      </div>
    </div>
  </details>
</div>

<script>
(function() {
  var textarea = document.getElementById('szGiftMessage');
  var counter = document.getElementById('szGiftMessageCount');

  if (textarea && counter) {
    textarea.addEventListener('input', function() {
      counter.textContent = this.value.length;
    });

    // Save note on change
    var saveTimeout;
    textarea.addEventListener('input', function() {
      clearTimeout(saveTimeout);
      var note = this.value;
      saveTimeout = setTimeout(function() {
        fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note: note })
        });
      }, 500);
    });
  }

  // Save gift checkbox
  var giftCheckbox = document.querySelector('input[name="attributes[is_gift]"]');
  if (giftCheckbox) {
    giftCheckbox.addEventListener('change', function() {
      fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          attributes: { is_gift: this.checked ? 'Yes' : '' }
        })
      });
    });
  }
})();
</script>

<style>
  .sz-gift-message {
    margin: var(--sz-space-md, 16px) 0;
  }

  .sz-gift-message__details {
    background: var(--sz-background, #FFFFFF);
    border: 1px solid var(--sz-border, #E8E4DE);
    border-radius: var(--sz-radius-lg, 12px);
    overflow: hidden;
  }

  .sz-gift-message__toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: var(--sz-space-md, 16px);
    background: var(--sz-background-alt, #FAF9F6);
    cursor: pointer;
    list-style: none;
    transition: background var(--sz-transition-fast, 0.2s) ease;
  }

  .sz-gift-message__toggle::-webkit-details-marker {
    display: none;
  }

  .sz-gift-message__toggle:hover {
    background: var(--sz-surface, #F5F2ED);
  }

  .sz-gift-message__toggle-content {
    display: flex;
    align-items: center;
    gap: var(--sz-space-sm, 10px);
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 14px);
    font-weight: var(--sz-font-medium, 500);
    color: var(--sz-heading);
  }

  .sz-gift-message__toggle-content svg {
    color: var(--sz-primary);
    flex-shrink: 0;
  }

  .sz-gift-message__free {
    font-size: 10px;
    font-weight: var(--sz-font-semibold, 600);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 2px 8px;
    background: var(--sz-success-light, #ECFDF5);
    color: var(--sz-success, #10B981);
    border-radius: var(--sz-radius-full, 999px);
  }

  .sz-gift-message__chevron {
    color: var(--sz-text-muted);
    transition: transform var(--sz-transition-fast, 0.2s) ease;
  }

  .sz-gift-message__details[open] .sz-gift-message__chevron {
    transform: rotate(180deg);
  }

  .sz-gift-message__content {
    padding: var(--sz-space-md, 16px);
    border-top: 1px solid var(--sz-border, #E8E4DE);
  }

  .sz-gift-message__label {
    display: block;
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-xs, 12px);
    font-weight: var(--sz-font-medium, 500);
    color: var(--sz-text-muted);
    margin-bottom: var(--sz-space-xs, 6px);
  }

  .sz-gift-message__textarea {
    width: 100%;
    padding: var(--sz-space-sm, 12px);
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 14px);
    line-height: var(--sz-leading-relaxed, 1.5);
    color: var(--sz-text);
    background: var(--sz-background, #FFFFFF);
    border: 1px solid var(--sz-border, #E8E4DE);
    border-radius: var(--sz-radius-md, 8px);
    resize: vertical;
    min-height: 80px;
  }

  .sz-gift-message__textarea:focus {
    outline: none;
    border-color: var(--sz-primary);
    box-shadow: 0 0 0 3px var(--sz-primary-light, rgba(139, 170, 136, 0.15));
  }

  .sz-gift-message__textarea::placeholder {
    color: var(--sz-text-muted);
  }

  .sz-gift-message__footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--sz-space-xs, 6px);
  }

  .sz-gift-message__counter {
    font-family: var(--sz-font-body);
    font-size: 11px;
    color: var(--sz-text-muted);
  }

  .sz-gift-message__hint {
    font-family: var(--sz-font-body);
    font-size: 11px;
    color: var(--sz-primary);
    font-style: italic;
  }

  .sz-gift-message__options {
    margin-top: var(--sz-space-md, 12px);
    padding-top: var(--sz-space-md, 12px);
    border-top: 1px solid var(--sz-border, #E8E4DE);
  }

  .sz-gift-message__checkbox {
    display: flex;
    align-items: center;
    gap: var(--sz-space-sm, 10px);
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 13px);
    color: var(--sz-text);
    cursor: pointer;
  }

  .sz-gift-message__checkbox input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
  }

  .sz-gift-message__checkmark {
    width: 18px;
    height: 18px;
    border: 2px solid var(--sz-border, #E8E4DE);
    border-radius: var(--sz-radius-sm, 4px);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--sz-transition-fast, 0.2s) ease;
    flex-shrink: 0;
  }

  .sz-gift-message__checkbox input:checked + .sz-gift-message__checkmark {
    background: var(--sz-primary);
    border-color: var(--sz-primary);
  }

  .sz-gift-message__checkbox input:checked + .sz-gift-message__checkmark::after {
    content: "";
    width: 5px;
    height: 9px;
    border: solid var(--sz-background, #FFFFFF);
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
  }

  .sz-gift-message__checkbox input:focus + .sz-gift-message__checkmark {
    box-shadow: 0 0 0 3px var(--sz-primary-light, rgba(139, 170, 136, 0.15));
  }
</style>
{%- endif -%}
