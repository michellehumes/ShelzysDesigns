{% comment %}
================================================================================
SHELZY'S DESIGNS - PREMIUM PERSONALIZATION SYSTEM
Version: 3.0.0
Last Updated: 2024-12
================================================================================
Complete personalization UX with live product image preview.
Overlays customer text directly on product photos in real-time.

Features:
- Name input with character limit & sanitization
- Font selector with visual previews
- Color selector with curated palette
- Live text overlay on product image
- Preview approval checkbox
- Graceful degradation if JS fails

Revenue Impact: Increases conversion 15-25% by reducing
personalization anxiety and showing exactly what they'll get.

Usage: {% render 'personalization-live-preview', product: product %}
================================================================================
{% endcomment %}

{%- liquid
  assign enable_personalization = true
  assign product_tags_lower = product.tags | join: ',' | downcase

  comment
    Check if personalization should be disabled for this product
  endcomment
  if product_tags_lower contains 'no-personalization'
    assign enable_personalization = false
  endif

  comment
    Get settings with defaults
  endcomment
  assign char_limit = settings.personalization_char_limit | default: 15
  assign max_chars = settings.personalization_max_chars | default: 20
  assign default_font = settings.personalization_default_font | default: 'script'
  assign default_color = settings.personalization_default_color | default: 'white'

  comment
    Determine if this is a set product (multiple names)
  endcomment
  assign is_set = false
  if product_tags_lower contains 'set' or product.title contains 'Set' or product.title contains 'Pack'
    assign is_set = true
  endif
-%}

{%- if enable_personalization -%}
<div class="sz-personalize" id="szPersonalize" data-char-limit="{{ char_limit }}" data-max-chars="{{ max_chars }}">

  {%- comment -%} ═══════════════════════════════════════════════════════════
     LIVE PREVIEW - White Bottle with Vertical Text Overlay
  ═══════════════════════════════════════════════════════════ {%- endcomment -%}
  <div class="sz-personalize__preview" id="szPreviewContainer">
    <div class="sz-personalize__bottle-wrap">
      {%- comment -%} White Bottle Mockup - SVG {%- endcomment -%}
      <div class="sz-personalize__bottle" id="szPreviewBottle">
        <svg viewBox="0 0 120 300" class="sz-personalize__bottle-svg" aria-hidden="true">
          {%- comment -%} Cap/Lid {%- endcomment -%}
          <rect x="40" y="0" width="40" height="25" rx="4" fill="#E8E8E8"/>
          <rect x="38" y="20" width="44" height="8" rx="2" fill="#D0D0D0"/>

          {%- comment -%} Neck {%- endcomment -%}
          <path d="M42 28 L42 45 Q42 55 48 60 L72 60 Q78 55 78 45 L78 28" fill="#FFFFFF" stroke="#E0E0E0" stroke-width="1"/>

          {%- comment -%} Main Body - White Bottle {%- endcomment -%}
          <path d="M48 60
                   Q35 70 30 100
                   L30 250
                   Q30 280 60 285
                   Q90 280 90 250
                   L90 100
                   Q85 70 72 60 Z"
                fill="#FFFFFF"
                stroke="#E0E0E0"
                stroke-width="1.5"/>

          {%- comment -%} Subtle highlight/reflection {%- endcomment -%}
          <path d="M35 100 Q33 150 35 200" stroke="#F5F5F5" stroke-width="8" stroke-linecap="round" fill="none" opacity="0.8"/>
          <path d="M40 80 L40 250" stroke="rgba(255,255,255,0.5)" stroke-width="3" fill="none"/>
        </svg>

        {%- comment -%} Text Overlay Layer - Vertical {%- endcomment -%}
        <div class="sz-personalize__text-overlay" id="szTextOverlay">
          <span
            class="sz-personalize__preview-text"
            id="szPreviewText"
            data-font="{{ default_font }}"
            data-color="{{ default_color }}"
          >Your Name</span>
        </div>
      </div>
    </div>

    {%- comment -%} Preview Confidence Badge {%- endcomment -%}
    <div class="sz-personalize__badge">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
      <span>Live preview — This is exactly how your bottle will look</span>
    </div>
  </div>

  {%- comment -%} ═══════════════════════════════════════════════════════════
     PERSONALIZATION FORM
  ═══════════════════════════════════════════════════════════ {%- endcomment -%}
  <div class="sz-personalize__form">

    {%- comment -%} ─────────────────────────────────────────────────
       NAME INPUT
    ───────────────────────────────────────────────── {%- endcomment -%}
    <div class="sz-personalize__field" id="szNameField">
      <label class="sz-personalize__label" for="szNameInput">
        {%- if is_set -%}
          Names to Print <span class="sz-personalize__hint">(one per line)</span>
        {%- else -%}
          Name to Print <span class="sz-personalize__required">*</span>
        {%- endif -%}
      </label>

      {%- if is_set -%}
        <textarea
          id="szNameInput"
          class="sz-personalize__textarea"
          name="properties[Names]"
          placeholder="Sarah&#10;Emily&#10;Jessica"
          rows="4"
          required
          aria-describedby="szNameHelp szNameCount"
        ></textarea>
        <div class="sz-personalize__field-footer">
          <span id="szNameCount" class="sz-personalize__count">0 names entered</span>
          <span id="szNameHelp" class="sz-personalize__help">Enter each name on a new line</span>
        </div>
      {%- else -%}
        <div class="sz-personalize__input-wrap">
          <input
            type="text"
            id="szNameInput"
            class="sz-personalize__input"
            name="properties[Name]"
            placeholder="Enter name here"
            maxlength="{{ max_chars }}"
            required
            autocomplete="off"
            autocorrect="off"
            autocapitalize="words"
            spellcheck="false"
            aria-describedby="szNameHelp szCharCount"
          >
          <span class="sz-personalize__char-count" id="szCharCount">
            <span id="szCharCurrent">0</span>/<span id="szCharLimit">{{ char_limit }}</span>
          </span>
        </div>
        <div class="sz-personalize__field-footer">
          <span id="szNameHelp" class="sz-personalize__help">
            {{ char_limit }} characters recommended for best appearance
          </span>
          <span class="sz-personalize__validation" id="szNameValidation" role="alert"></span>
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} ─────────────────────────────────────────────────
       FONT SELECTOR
    ───────────────────────────────────────────────── {%- endcomment -%}
    <div class="sz-personalize__field">
      <label class="sz-personalize__label">
        Font Style <span class="sz-personalize__required">*</span>
      </label>

      <div class="sz-personalize__fonts" id="szFonts" role="radiogroup" aria-label="Select font style">
        <button
          type="button"
          class="sz-personalize__font{% if default_font == 'script' %} sz-personalize__font--selected{% endif %}"
          data-font="script"
          data-font-family="'Pinyon Script', cursive"
          role="radio"
          aria-checked="{% if default_font == 'script' %}true{% else %}false{% endif %}"
        >
          <span class="sz-personalize__font-preview" style="font-family: 'Pinyon Script', cursive;">Sarah</span>
          <span class="sz-personalize__font-name">Elegant Script</span>
        </button>

        <button
          type="button"
          class="sz-personalize__font{% if default_font == 'serif' %} sz-personalize__font--selected{% endif %}"
          data-font="serif"
          data-font-family="'Playfair Display', serif"
          role="radio"
          aria-checked="{% if default_font == 'serif' %}true{% else %}false{% endif %}"
        >
          <span class="sz-personalize__font-preview" style="font-family: 'Playfair Display', serif;">Sarah</span>
          <span class="sz-personalize__font-name">Classic Serif</span>
        </button>

        <button
          type="button"
          class="sz-personalize__font{% if default_font == 'modern' %} sz-personalize__font--selected{% endif %}"
          data-font="modern"
          data-font-family="'Montserrat', sans-serif"
          role="radio"
          aria-checked="{% if default_font == 'modern' %}true{% else %}false{% endif %}"
        >
          <span class="sz-personalize__font-preview" style="font-family: 'Montserrat', sans-serif; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em;">SARAH</span>
          <span class="sz-personalize__font-name">Modern Sans</span>
        </button>

        <button
          type="button"
          class="sz-personalize__font{% if default_font == 'handwritten' %} sz-personalize__font--selected{% endif %}"
          data-font="handwritten"
          data-font-family="'Dancing Script', cursive"
          role="radio"
          aria-checked="{% if default_font == 'handwritten' %}true{% else %}false{% endif %}"
        >
          <span class="sz-personalize__font-preview" style="font-family: 'Dancing Script', cursive;">Sarah</span>
          <span class="sz-personalize__font-name">Handwritten</span>
        </button>

        <button
          type="button"
          class="sz-personalize__font{% if default_font == 'bold' %} sz-personalize__font--selected{% endif %}"
          data-font="bold"
          data-font-family="'Oswald', sans-serif"
          role="radio"
          aria-checked="{% if default_font == 'bold' %}true{% else %}false{% endif %}"
        >
          <span class="sz-personalize__font-preview" style="font-family: 'Oswald', sans-serif; font-weight: 600; text-transform: uppercase;">SARAH</span>
          <span class="sz-personalize__font-name">Bold Block</span>
        </button>

        <button
          type="button"
          class="sz-personalize__font{% if default_font == 'minimal' %} sz-personalize__font--selected{% endif %}"
          data-font="minimal"
          data-font-family="'Inter', sans-serif"
          role="radio"
          aria-checked="{% if default_font == 'minimal' %}true{% else %}false{% endif %}"
        >
          <span class="sz-personalize__font-preview" style="font-family: 'Inter', sans-serif; font-weight: 300; letter-spacing: 0.15em;">Sarah</span>
          <span class="sz-personalize__font-name">Minimal</span>
        </button>
      </div>

      <input type="hidden" name="properties[Font Style]" id="szFontInput" value="Elegant Script">
    </div>

    {%- comment -%} ─────────────────────────────────────────────────
       COLOR SELECTOR
    ───────────────────────────────────────────────── {%- endcomment -%}
    <div class="sz-personalize__field">
      <label class="sz-personalize__label">
        Text Color <span class="sz-personalize__required">*</span>
      </label>

      <div class="sz-personalize__colors" id="szColors" role="radiogroup" aria-label="Select text color">
        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'white' %} sz-personalize__color--selected{% endif %}"
          data-color="white"
          data-color-hex="#FFFFFF"
          data-color-name="White"
          style="background: #FFFFFF; border: 1px solid #E0E0E0;"
          role="radio"
          aria-checked="{% if default_color == 'white' %}true{% else %}false{% endif %}"
          aria-label="White"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>

        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'black' %} sz-personalize__color--selected{% endif %}"
          data-color="black"
          data-color-hex="#1A1A1A"
          data-color-name="Black"
          style="background: #1A1A1A;"
          role="radio"
          aria-checked="{% if default_color == 'black' %}true{% else %}false{% endif %}"
          aria-label="Black"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>

        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'gold' %} sz-personalize__color--selected{% endif %}"
          data-color="gold"
          data-color-hex="#D4AF37"
          data-color-name="Gold"
          style="background: linear-gradient(135deg, #D4AF37 0%, #F5D061 50%, #D4AF37 100%);"
          role="radio"
          aria-checked="{% if default_color == 'gold' %}true{% else %}false{% endif %}"
          aria-label="Gold"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>

        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'rose-gold' %} sz-personalize__color--selected{% endif %}"
          data-color="rose-gold"
          data-color-hex="#B76E79"
          data-color-name="Rose Gold"
          style="background: linear-gradient(135deg, #B76E79 0%, #E8B4B8 50%, #B76E79 100%);"
          role="radio"
          aria-checked="{% if default_color == 'rose-gold' %}true{% else %}false{% endif %}"
          aria-label="Rose Gold"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>

        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'silver' %} sz-personalize__color--selected{% endif %}"
          data-color="silver"
          data-color-hex="#A8A8A8"
          data-color-name="Silver"
          style="background: linear-gradient(135deg, #A8A8A8 0%, #E8E8E8 50%, #A8A8A8 100%);"
          role="radio"
          aria-checked="{% if default_color == 'silver' %}true{% else %}false{% endif %}"
          aria-label="Silver"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>

        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'pink' %} sz-personalize__color--selected{% endif %}"
          data-color="pink"
          data-color-hex="#FF69B4"
          data-color-name="Hot Pink"
          style="background: #FF69B4;"
          role="radio"
          aria-checked="{% if default_color == 'pink' %}true{% else %}false{% endif %}"
          aria-label="Hot Pink"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>

        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'navy' %} sz-personalize__color--selected{% endif %}"
          data-color="navy"
          data-color-hex="#2C3E50"
          data-color-name="Navy"
          style="background: #2C3E50;"
          role="radio"
          aria-checked="{% if default_color == 'navy' %}true{% else %}false{% endif %}"
          aria-label="Navy"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>

        <button
          type="button"
          class="sz-personalize__color{% if default_color == 'sage' %} sz-personalize__color--selected{% endif %}"
          data-color="sage"
          data-color-hex="#8BAA88"
          data-color-name="Sage Green"
          style="background: #8BAA88;"
          role="radio"
          aria-checked="{% if default_color == 'sage' %}true{% else %}false{% endif %}"
          aria-label="Sage Green"
        >
          <span class="sz-personalize__color-check">✓</span>
        </button>
      </div>

      <p class="sz-personalize__color-selected">
        Selected: <strong id="szColorLabel">{{ default_color | capitalize }}</strong>
      </p>

      <input type="hidden" name="properties[Text Color]" id="szColorInput" value="{{ default_color | capitalize }}">
    </div>

    {%- comment -%} ─────────────────────────────────────────────────
       PREVIEW APPROVAL & HELP
    ───────────────────────────────────────────────── {%- endcomment -%}
    <div class="sz-personalize__approval">
      <label class="sz-personalize__checkbox">
        <input type="checkbox" id="szPreviewApproved" name="properties[Preview Approved]" value="Yes">
        <span class="sz-personalize__checkmark"></span>
        <span class="sz-personalize__checkbox-text">
          I've reviewed the preview and approve this design
        </span>
      </label>
    </div>

    <div class="sz-personalize__help-box">
      <details class="sz-personalize__help-details">
        <summary class="sz-personalize__help-summary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <span>Need help personalizing?</span>
        </summary>
        <div class="sz-personalize__help-content">
          <ul>
            <li><strong>First names work best</strong> — Short names (under 10 characters) look cleanest</li>
            <li><strong>Avoid special characters</strong> — Letters and numbers only for best results</li>
            <li><strong>Double-check spelling</strong> — Personalized items cannot be returned</li>
            <li><strong>Questions?</strong> <a href="/pages/contact">Contact us</a> before ordering</li>
          </ul>
        </div>
      </details>
    </div>

  </div>
</div>

{%- comment -%} ═══════════════════════════════════════════════════════════
   FONTS - Load Google Fonts for live preview
═══════════════════════════════════════════════════════════ {%- endcomment -%}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500&family=Inter:wght@300;400;500&family=Montserrat:wght@400;500;600&family=Oswald:wght@400;600&family=Pinyon+Script&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

{%- comment -%} ═══════════════════════════════════════════════════════════
   JAVASCRIPT - Personalization Logic
═══════════════════════════════════════════════════════════ {%- endcomment -%}
<script>
(function() {
  'use strict';

  // State
  var state = {
    name: '',
    font: '{{ default_font }}',
    fontFamily: "'Pinyon Script', cursive",
    fontLabel: 'Elegant Script',
    color: '{{ default_color }}',
    colorHex: '#FFFFFF',
    colorLabel: '{{ default_color | capitalize }}',
    approved: false
  };

  // DOM Elements
  var els = {
    container: document.getElementById('szPersonalize'),
    nameInput: document.getElementById('szNameInput'),
    charCurrent: document.getElementById('szCharCurrent'),
    charCount: document.getElementById('szCharCount'),
    nameCount: document.getElementById('szNameCount'),
    nameValidation: document.getElementById('szNameValidation'),
    previewText: document.getElementById('szPreviewText'),
    previewBottle: document.getElementById('szPreviewBottle'),
    fonts: document.getElementById('szFonts'),
    fontInput: document.getElementById('szFontInput'),
    colors: document.getElementById('szColors'),
    colorInput: document.getElementById('szColorInput'),
    colorLabel: document.getElementById('szColorLabel'),
    approvedCheckbox: document.getElementById('szPreviewApproved')
  };

  // Settings from data attributes
  var charLimit = parseInt(els.container.dataset.charLimit) || 15;
  var maxChars = parseInt(els.container.dataset.maxChars) || 20;

  // Font mapping
  var fontMap = {
    'script': { family: "'Pinyon Script', cursive", label: 'Elegant Script', transform: 'none' },
    'serif': { family: "'Playfair Display', serif", label: 'Classic Serif', transform: 'none' },
    'modern': { family: "'Montserrat', sans-serif", label: 'Modern Sans', transform: 'uppercase' },
    'handwritten': { family: "'Dancing Script', cursive", label: 'Handwritten', transform: 'none' },
    'bold': { family: "'Oswald', sans-serif", label: 'Bold Block', transform: 'uppercase' },
    'minimal': { family: "'Inter', sans-serif", label: 'Minimal', transform: 'none' }
  };

  // ═══════════════════════════════════════════════════════════
  // NAME INPUT HANDLING
  // ═══════════════════════════════════════════════════════════

  function sanitizeName(value) {
    // Remove potentially problematic characters but allow letters, numbers, spaces, basic punctuation
    return value.replace(/[<>\"\'\\\/\{\}\[\]]/g, '').trim();
  }

  function handleNameInput(e) {
    var rawValue = e.target.value;
    var sanitized = sanitizeName(rawValue);

    // If sanitization changed the value, update input
    if (sanitized !== rawValue) {
      e.target.value = sanitized;
    }

    state.name = sanitized;
    var length = sanitized.length;

    // Update character count (for single name input)
    if (els.charCurrent) {
      els.charCurrent.textContent = length;

      // Update count styling
      if (els.charCount) {
        els.charCount.classList.remove('sz-personalize__char-count--warning', 'sz-personalize__char-count--error');
        if (length > charLimit && length <= maxChars) {
          els.charCount.classList.add('sz-personalize__char-count--warning');
        } else if (length > maxChars) {
          els.charCount.classList.add('sz-personalize__char-count--error');
        }
      }
    }

    // Update name count (for multi-name textarea)
    if (els.nameCount) {
      var names = sanitized.split('\n').filter(function(n) { return n.trim() !== ''; });
      var count = names.length;
      els.nameCount.textContent = count + ' name' + (count !== 1 ? 's' : '') + ' entered';
      // Use first name for preview
      state.name = names[0] || '';
    }

    // Validate
    validateName();

    // Update preview
    updatePreview();
  }

  function validateName() {
    if (!els.nameValidation) return;

    var value = state.name;
    var message = '';
    var isValid = true;

    if (value.length === 0) {
      message = '';
      isValid = false;
    } else if (value.length > maxChars) {
      message = 'Name is too long. Please shorten it.';
      isValid = false;
    } else if (!/^[a-zA-Z0-9\s\-\'\.]+$/.test(value)) {
      message = 'Please use only letters, numbers, and basic punctuation.';
      isValid = false;
    }

    els.nameValidation.textContent = message;
    els.nameValidation.classList.toggle('sz-personalize__validation--error', !isValid && message);
    els.nameInput.classList.toggle('sz-personalize__input--invalid', !isValid && message);

    return isValid;
  }

  // ═══════════════════════════════════════════════════════════
  // FONT SELECTION
  // ═══════════════════════════════════════════════════════════

  function handleFontClick(e) {
    var btn = e.target.closest('.sz-personalize__font');
    if (!btn) return;

    // Update selection state
    els.fonts.querySelectorAll('.sz-personalize__font').forEach(function(el) {
      el.classList.remove('sz-personalize__font--selected');
      el.setAttribute('aria-checked', 'false');
    });
    btn.classList.add('sz-personalize__font--selected');
    btn.setAttribute('aria-checked', 'true');

    // Update state
    var fontKey = btn.dataset.font;
    state.font = fontKey;
    state.fontFamily = fontMap[fontKey].family;
    state.fontLabel = fontMap[fontKey].label;

    // Update hidden input
    els.fontInput.value = state.fontLabel;

    // Update preview
    updatePreview();
  }

  // ═══════════════════════════════════════════════════════════
  // COLOR SELECTION
  // ═══════════════════════════════════════════════════════════

  function handleColorClick(e) {
    var btn = e.target.closest('.sz-personalize__color');
    if (!btn) return;

    // Update selection state
    els.colors.querySelectorAll('.sz-personalize__color').forEach(function(el) {
      el.classList.remove('sz-personalize__color--selected');
      el.setAttribute('aria-checked', 'false');
    });
    btn.classList.add('sz-personalize__color--selected');
    btn.setAttribute('aria-checked', 'true');

    // Update state
    state.color = btn.dataset.color;
    state.colorHex = btn.dataset.colorHex;
    state.colorLabel = btn.dataset.colorName;

    // Update hidden input and label
    els.colorInput.value = state.colorLabel;
    els.colorLabel.textContent = state.colorLabel;

    // Update preview
    updatePreview();
  }

  // ═══════════════════════════════════════════════════════════
  // LIVE PREVIEW UPDATE - VERTICAL TEXT ON WHITE BOTTLE
  // ═══════════════════════════════════════════════════════════

  function updatePreview() {
    if (!els.previewText) return;

    var displayText = state.name || 'Your Name';

    // Update text content
    els.previewText.textContent = displayText;

    // Update font
    els.previewText.style.fontFamily = state.fontFamily;

    // Apply text transform based on font
    var transform = fontMap[state.font] ? fontMap[state.font].transform : 'none';
    els.previewText.style.textTransform = transform;

    // Update color (on white bottle, darker colors work better)
    els.previewText.style.color = state.colorHex;

    // Text shadow for contrast on white bottle
    if (state.color === 'white' || state.color === 'silver') {
      // Light colors need dark shadow on white bottle
      els.previewText.style.textShadow = '0 1px 3px rgba(0,0,0,0.3)';
    } else {
      // Dark colors - subtle shadow
      els.previewText.style.textShadow = '0 1px 2px rgba(0,0,0,0.15)';
    }

    // Scale text based on length (for vertical layout)
    var length = displayText.length;
    var scale = 1;
    if (length > 10) scale = 0.9;
    if (length > 12) scale = 0.8;
    if (length > 15) scale = 0.7;

    // For vertical text, use rotate(180deg) to keep bottom-to-top orientation
    els.previewText.style.transform = 'rotate(180deg) scale(' + scale + ')';
  }

  // ═══════════════════════════════════════════════════════════
  // FORM VALIDATION ON SUBMIT
  // ═══════════════════════════════════════════════════════════

  function handleFormSubmit(e) {
    var form = e.target.closest('form');
    if (!form) return;

    // Check if name is entered
    if (!state.name.trim()) {
      e.preventDefault();
      els.nameInput.focus();
      if (els.nameValidation) {
        els.nameValidation.textContent = 'Please enter a name for your bottle';
        els.nameValidation.classList.add('sz-personalize__validation--error');
      }
      els.nameInput.classList.add('sz-personalize__input--invalid');

      // Scroll to personalization section
      els.container.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return false;
    }

    // Validate name format
    if (!validateName()) {
      e.preventDefault();
      els.nameInput.focus();
      els.container.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return false;
    }

    return true;
  }

  // ═══════════════════════════════════════════════════════════
  // INITIALIZATION
  // ═══════════════════════════════════════════════════════════

  function init() {
    if (!els.container) return;

    // Name input listener
    if (els.nameInput) {
      els.nameInput.addEventListener('input', handleNameInput);
      els.nameInput.addEventListener('blur', validateName);
    }

    // Font selection
    if (els.fonts) {
      els.fonts.addEventListener('click', handleFontClick);
    }

    // Color selection
    if (els.colors) {
      els.colors.addEventListener('click', handleColorClick);
    }

    // Form submit validation
    var productForm = document.querySelector('#szProductForm, .product-form, form[action*="/cart/add"]');
    if (productForm) {
      productForm.addEventListener('submit', handleFormSubmit);
    }

    // Set initial font state from selected button
    var selectedFont = els.fonts.querySelector('.sz-personalize__font--selected');
    if (selectedFont) {
      state.font = selectedFont.dataset.font;
      state.fontFamily = fontMap[state.font].family;
      state.fontLabel = fontMap[state.font].label;
      els.fontInput.value = state.fontLabel;
    }

    // Set initial color state from selected button
    var selectedColor = els.colors.querySelector('.sz-personalize__color--selected');
    if (selectedColor) {
      state.color = selectedColor.dataset.color;
      state.colorHex = selectedColor.dataset.colorHex;
      state.colorLabel = selectedColor.dataset.colorName;
      els.colorInput.value = state.colorLabel;
    }

    // Initial preview update
    updatePreview();
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

{%- comment -%} ═══════════════════════════════════════════════════════════
   CSS STYLES
═══════════════════════════════════════════════════════════ {%- endcomment -%}
<style>
  .sz-personalize {
    --sz-p-primary: var(--sz-primary, #8BAA88);
    --sz-p-primary-dark: var(--sz-primary-dark, #4E5F4A);
    --sz-p-text: var(--sz-text, #2B2B2B);
    --sz-p-text-muted: var(--sz-text-muted, #7A7A7A);
    --sz-p-border: var(--sz-border, #E8E4DE);
    --sz-p-surface: var(--sz-surface, #F5F2ED);
    --sz-p-background: var(--sz-background, #FFFFFF);
    --sz-p-error: var(--sz-error, #DC2626);
    --sz-p-warning: var(--sz-accent, #F59E0B);

    padding: var(--sz-space-lg, 24px) 0;
  }

  /* ─────────────────────────────────────────────────
     LIVE PREVIEW SECTION - WHITE BOTTLE
  ───────────────────────────────────────────────── */
  .sz-personalize__preview {
    margin-bottom: var(--sz-space-xl, 32px);
  }

  .sz-personalize__bottle-wrap {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, #F8F8F8 0%, #E8E8E8 100%);
    border-radius: var(--sz-radius-lg, 12px);
    padding: var(--sz-space-xl, 32px);
    max-width: 320px;
    margin: 0 auto;
  }

  .sz-personalize__bottle {
    position: relative;
    width: 120px;
    height: 300px;
  }

  .sz-personalize__bottle-svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
  }

  /* Text Overlay - Vertical (bottom to top) */
  .sz-personalize__text-overlay {
    position: absolute;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .sz-personalize__preview-text {
    font-family: 'Pinyon Script', cursive;
    font-size: clamp(18px, 4vw, 24px);
    color: #1A1A1A;
    text-shadow: none;
    white-space: nowrap;
    transition: all 0.15s ease;

    /* Vertical text - bottom to top */
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    letter-spacing: 0.05em;
    max-height: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Preview Badge */
  .sz-personalize__badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--sz-space-xs, 6px);
    margin-top: var(--sz-space-md, 16px);
    padding: var(--sz-space-sm, 10px) var(--sz-space-md, 16px);
    background: var(--sz-primary-light, #EDF3EC);
    border-radius: var(--sz-radius-full, 999px);
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-xs, 12px);
    color: var(--sz-p-primary-dark);
  }

  .sz-personalize__badge svg {
    color: var(--sz-p-primary);
    flex-shrink: 0;
  }

  /* ─────────────────────────────────────────────────
     FORM FIELDS
  ───────────────────────────────────────────────── */
  .sz-personalize__form {
    max-width: 500px;
    margin: 0 auto;
  }

  .sz-personalize__field {
    margin-bottom: var(--sz-space-lg, 24px);
  }

  .sz-personalize__label {
    display: block;
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 14px);
    font-weight: var(--sz-font-semibold, 600);
    color: var(--sz-p-text);
    margin-bottom: var(--sz-space-sm, 10px);
  }

  .sz-personalize__required {
    color: var(--sz-p-error);
  }

  .sz-personalize__hint {
    font-weight: var(--sz-font-normal, 400);
    color: var(--sz-p-text-muted);
  }

  /* Name Input */
  .sz-personalize__input-wrap {
    position: relative;
  }

  .sz-personalize__input,
  .sz-personalize__textarea {
    width: 100%;
    padding: var(--sz-space-md, 16px);
    padding-right: 80px;
    font-family: var(--sz-font-body);
    font-size: 16px; /* Prevents iOS zoom */
    color: var(--sz-p-text);
    background: var(--sz-p-background);
    border: 2px solid var(--sz-p-border);
    border-radius: var(--sz-radius-md, 8px);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .sz-personalize__textarea {
    padding-right: var(--sz-space-md, 16px);
    resize: vertical;
    min-height: 120px;
  }

  .sz-personalize__input:focus,
  .sz-personalize__textarea:focus {
    outline: none;
    border-color: var(--sz-p-primary);
    box-shadow: 0 0 0 3px rgba(139, 170, 136, 0.15);
  }

  .sz-personalize__input--invalid {
    border-color: var(--sz-p-error);
  }

  .sz-personalize__input--invalid:focus {
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
  }

  /* Character Count */
  .sz-personalize__char-count {
    position: absolute;
    right: var(--sz-space-md, 16px);
    top: 50%;
    transform: translateY(-50%);
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-xs, 12px);
    color: var(--sz-p-text-muted);
    pointer-events: none;
  }

  .sz-personalize__char-count--warning {
    color: var(--sz-p-warning);
  }

  .sz-personalize__char-count--error {
    color: var(--sz-p-error);
  }

  .sz-personalize__field-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--sz-space-xs, 6px);
    flex-wrap: wrap;
    gap: var(--sz-space-xs, 4px);
  }

  .sz-personalize__help {
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-xs, 11px);
    color: var(--sz-p-text-muted);
  }

  .sz-personalize__count {
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-xs, 12px);
    font-weight: var(--sz-font-medium, 500);
    color: var(--sz-p-primary-dark);
  }

  .sz-personalize__validation {
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-xs, 12px);
    min-height: 16px;
  }

  .sz-personalize__validation--error {
    color: var(--sz-p-error);
  }

  /* ─────────────────────────────────────────────────
     FONT SELECTOR
  ───────────────────────────────────────────────── */
  .sz-personalize__fonts {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--sz-space-sm, 10px);
  }

  @media (max-width: 500px) {
    .sz-personalize__fonts {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .sz-personalize__font {
    padding: var(--sz-space-md, 16px) var(--sz-space-sm, 12px);
    background: var(--sz-p-background);
    border: 2px solid var(--sz-p-border);
    border-radius: var(--sz-radius-md, 8px);
    cursor: pointer;
    text-align: center;
    transition: all 0.2s ease;
  }

  .sz-personalize__font:hover {
    border-color: var(--sz-p-primary);
  }

  .sz-personalize__font--selected {
    border-color: var(--sz-p-primary-dark);
    background: var(--sz-p-surface);
  }

  .sz-personalize__font-preview {
    display: block;
    font-size: 20px;
    color: var(--sz-p-text);
    min-height: 28px;
    margin-bottom: var(--sz-space-xs, 6px);
  }

  .sz-personalize__font-name {
    display: block;
    font-family: var(--sz-font-body);
    font-size: 10px;
    color: var(--sz-p-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ─────────────────────────────────────────────────
     COLOR SELECTOR
  ───────────────────────────────────────────────── */
  .sz-personalize__colors {
    display: flex;
    flex-wrap: wrap;
    gap: var(--sz-space-sm, 12px);
  }

  .sz-personalize__color {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
  }

  .sz-personalize__color:hover {
    transform: scale(1.1);
  }

  .sz-personalize__color--selected {
    border-color: var(--sz-p-primary-dark);
    box-shadow: 0 0 0 2px var(--sz-p-background), 0 0 0 4px var(--sz-p-primary-dark);
  }

  .sz-personalize__color-check {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #FFFFFF;
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.2s ease;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  }

  .sz-personalize__color--selected .sz-personalize__color-check {
    opacity: 1;
  }

  .sz-personalize__color[data-color="white"] .sz-personalize__color-check {
    color: var(--sz-p-text);
    text-shadow: none;
  }

  .sz-personalize__color-selected {
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 13px);
    color: var(--sz-p-text-muted);
    margin: var(--sz-space-sm, 10px) 0 0 0;
  }

  .sz-personalize__color-selected strong {
    color: var(--sz-p-text);
  }

  /* ─────────────────────────────────────────────────
     APPROVAL CHECKBOX
  ───────────────────────────────────────────────── */
  .sz-personalize__approval {
    padding: var(--sz-space-md, 16px);
    background: var(--sz-p-surface);
    border-radius: var(--sz-radius-md, 8px);
    margin-bottom: var(--sz-space-md, 16px);
  }

  .sz-personalize__checkbox {
    display: flex;
    align-items: flex-start;
    gap: var(--sz-space-sm, 12px);
    cursor: pointer;
  }

  .sz-personalize__checkbox input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
  }

  .sz-personalize__checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid var(--sz-p-border);
    border-radius: var(--sz-radius-sm, 4px);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .sz-personalize__checkbox input:checked + .sz-personalize__checkmark {
    background: var(--sz-p-primary);
    border-color: var(--sz-p-primary);
  }

  .sz-personalize__checkbox input:checked + .sz-personalize__checkmark::after {
    content: "";
    width: 5px;
    height: 9px;
    border: solid var(--sz-p-background);
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
  }

  .sz-personalize__checkbox input:focus + .sz-personalize__checkmark {
    box-shadow: 0 0 0 3px rgba(139, 170, 136, 0.15);
  }

  .sz-personalize__checkbox-text {
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 14px);
    color: var(--sz-p-text);
    line-height: 1.4;
  }

  /* ─────────────────────────────────────────────────
     HELP BOX
  ───────────────────────────────────────────────── */
  .sz-personalize__help-box {
    margin-top: var(--sz-space-md, 16px);
  }

  .sz-personalize__help-details {
    border: 1px solid var(--sz-p-border);
    border-radius: var(--sz-radius-md, 8px);
    overflow: hidden;
  }

  .sz-personalize__help-summary {
    display: flex;
    align-items: center;
    gap: var(--sz-space-sm, 8px);
    padding: var(--sz-space-md, 14px) var(--sz-space-md, 16px);
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 14px);
    color: var(--sz-p-text-muted);
    cursor: pointer;
    list-style: none;
    transition: background 0.2s ease;
  }

  .sz-personalize__help-summary::-webkit-details-marker {
    display: none;
  }

  .sz-personalize__help-summary:hover {
    background: var(--sz-p-surface);
  }

  .sz-personalize__help-summary svg {
    color: var(--sz-p-primary);
    flex-shrink: 0;
  }

  .sz-personalize__help-content {
    padding: 0 var(--sz-space-md, 16px) var(--sz-space-md, 16px);
    border-top: 1px solid var(--sz-p-border);
  }

  .sz-personalize__help-content ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sz-personalize__help-content li {
    font-family: var(--sz-font-body);
    font-size: var(--sz-text-sm, 13px);
    color: var(--sz-p-text-muted);
    line-height: 1.5;
    padding: var(--sz-space-xs, 6px) 0;
  }

  .sz-personalize__help-content li strong {
    color: var(--sz-p-text);
  }

  .sz-personalize__help-content a {
    color: var(--sz-p-primary);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .sz-personalize__help-content a:hover {
    color: var(--sz-p-primary-dark);
  }

  /* ─────────────────────────────────────────────────
     MOBILE RESPONSIVE
  ───────────────────────────────────────────────── */
  @media (max-width: 600px) {
    .sz-personalize {
      padding: var(--sz-space-md, 16px) 0;
    }

    .sz-personalize__bottle-wrap {
      max-width: 280px;
      padding: var(--sz-space-lg, 24px);
    }

    .sz-personalize__bottle {
      width: 100px;
      height: 250px;
    }

    .sz-personalize__preview-text {
      font-size: clamp(16px, 4vw, 20px);
      max-height: 150px;
    }

    .sz-personalize__badge {
      font-size: 11px;
      padding: var(--sz-space-xs, 8px) var(--sz-space-sm, 12px);
    }

    .sz-personalize__font {
      padding: var(--sz-space-sm, 12px) var(--sz-space-xs, 8px);
    }

    .sz-personalize__font-preview {
      font-size: 18px;
    }

    .sz-personalize__color {
      width: 40px;
      height: 40px;
    }
  }

  /* Touch feedback for mobile */
  @media (hover: none) {
    .sz-personalize__font:active,
    .sz-personalize__color:active {
      transform: scale(0.95);
    }
  }

  /* ─────────────────────────────────────────────────
     NO-JS FALLBACK
  ───────────────────────────────────────────────── */
  .no-js .sz-personalize__preview,
  .no-js .sz-personalize__bottle-wrap {
    display: none;
  }

  .no-js .sz-personalize__badge {
    display: none;
  }
</style>
{%- endif -%}

{%- comment -%}
  NOSCRIPT FALLBACK - Simple form if JavaScript is disabled
{%- endcomment -%}
<noscript>
  <style>
    .sz-personalize { display: none !important; }
    .sz-personalize-noscript { display: block !important; }
  </style>
  <div class="sz-personalize-noscript" style="padding: 20px 0;">
    <p style="margin-bottom: 16px; font-weight: 600;">Personalization Options:</p>
    <label style="display: block; margin-bottom: 8px;">Name to Print:</label>
    <input type="text" name="properties[Name]" maxlength="20" required style="width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #ccc;">
    <label style="display: block; margin-bottom: 8px;">Font Style:</label>
    <select name="properties[Font Style]" style="width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #ccc;">
      <option value="Elegant Script">Elegant Script</option>
      <option value="Classic Serif">Classic Serif</option>
      <option value="Modern Sans">Modern Sans</option>
      <option value="Handwritten">Handwritten</option>
      <option value="Bold Block">Bold Block</option>
      <option value="Minimal">Minimal</option>
    </select>
    <label style="display: block; margin-bottom: 8px;">Text Color:</label>
    <select name="properties[Text Color]" style="width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #ccc;">
      <option value="White">White</option>
      <option value="Black">Black</option>
      <option value="Gold">Gold</option>
      <option value="Rose Gold">Rose Gold</option>
      <option value="Silver">Silver</option>
      <option value="Hot Pink">Hot Pink</option>
      <option value="Navy">Navy</option>
      <option value="Sage Green">Sage Green</option>
    </select>
  </div>
</noscript>
