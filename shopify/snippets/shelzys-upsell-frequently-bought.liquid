{% comment %}
  Frequently Bought Together / Upsell Component
  Installation: Add {% render 'upsell-frequently-bought', product: product %} on product pages
{% endcomment %}

<style>
  .shelzy-upsell {
    margin: 30px 0;
    padding: 24px;
    background: #faf9f7;
    border-radius: 12px;
  }

  .shelzy-upsell-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .shelzy-upsell-title {
    font-size: 18px;
    font-weight: 600;
    color: #321004;
    margin: 0;
  }

  .shelzy-upsell-savings {
    background: #dc2626;
    color: #fff;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }

  .shelzy-upsell-products {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }

  .shelzy-upsell-product {
    display: flex;
    align-items: center;
    gap: 12px;
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    flex: 1;
    min-width: 200px;
  }

  .shelzy-upsell-product-image {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .shelzy-upsell-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .shelzy-upsell-product-info {
    flex: 1;
    min-width: 0;
  }

  .shelzy-upsell-product-title {
    font-size: 14px;
    font-weight: 600;
    color: #321004;
    margin: 0 0 4px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .shelzy-upsell-product-price {
    font-size: 14px;
    color: #666;
  }

  .shelzy-upsell-plus {
    font-size: 24px;
    color: #ccc;
    padding: 0 8px;
  }

  .shelzy-upsell-total {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e5e5e5;
  }

  .shelzy-upsell-total-text {
    font-size: 16px;
    color: #333;
  }

  .shelzy-upsell-total-text strong {
    font-size: 20px;
    color: #321004;
  }

  .shelzy-upsell-total-text del {
    color: #999;
    font-size: 14px;
    margin-left: 8px;
  }

  .shelzy-upsell-btn {
    padding: 14px 28px;
    background: #321004;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .shelzy-upsell-btn:hover {
    background: #4a1a08;
  }

  @media (max-width: 600px) {
    .shelzy-upsell-products {
      flex-direction: column;
    }

    .shelzy-upsell-product {
      width: 100%;
    }

    .shelzy-upsell-plus {
      display: none;
    }

    .shelzy-upsell-total {
      flex-direction: column;
      gap: 16px;
      text-align: center;
    }

    .shelzy-upsell-btn {
      width: 100%;
    }
  }
</style>

{% comment %} Get related products - customize based on your collections {% endcomment %}
{% assign upsell_products = product.collections.first.products | where_exp: "p", "p.id != product.id" | slice: 0, 2 %}

{% if upsell_products.size > 0 %}
<div class="shelzy-upsell" data-product-id="{{ product.id }}">
  <div class="shelzy-upsell-header">
    <h3 class="shelzy-upsell-title">Frequently Bought Together</h3>
    <span class="shelzy-upsell-savings">Save 10%</span>
  </div>

  <div class="shelzy-upsell-products">
    <!-- Current Product -->
    <div class="shelzy-upsell-product">
      <div class="shelzy-upsell-product-image">
        {% if product.featured_image %}
          <img src="{{ product.featured_image | image_url: width: 120 }}" alt="{{ product.title }}">
        {% endif %}
      </div>
      <div class="shelzy-upsell-product-info">
        <p class="shelzy-upsell-product-title">{{ product.title | truncate: 30 }}</p>
        <p class="shelzy-upsell-product-price">{{ product.price | money }}</p>
      </div>
    </div>

    <span class="shelzy-upsell-plus">+</span>

    <!-- Upsell Product -->
    {% for upsell_product in upsell_products limit: 1 %}
      <div class="shelzy-upsell-product">
        <div class="shelzy-upsell-product-image">
          {% if upsell_product.featured_image %}
            <img src="{{ upsell_product.featured_image | image_url: width: 120 }}" alt="{{ upsell_product.title }}">
          {% endif %}
        </div>
        <div class="shelzy-upsell-product-info">
          <p class="shelzy-upsell-product-title">{{ upsell_product.title | truncate: 30 }}</p>
          <p class="shelzy-upsell-product-price">{{ upsell_product.price | money }}</p>
        </div>
      </div>
    {% endfor %}
  </div>

  {% assign bundle_total = product.price %}
  {% for upsell_product in upsell_products limit: 1 %}
    {% assign bundle_total = bundle_total | plus: upsell_product.price %}
  {% endfor %}
  {% assign bundle_discount = bundle_total | times: 0.10 %}
  {% assign bundle_price = bundle_total | minus: bundle_discount %}

  <div class="shelzy-upsell-total">
    <div class="shelzy-upsell-total-text">
      Total: <strong>{{ bundle_price | money }}</strong>
      <del>{{ bundle_total | money }}</del>
    </div>
    <button class="shelzy-upsell-btn" id="addBundleToCart">
      Add Both to Cart
    </button>
  </div>
</div>

<script>
(function() {
  const bundleBtn = document.getElementById('addBundleToCart');
  if (!bundleBtn) return;

  bundleBtn.addEventListener('click', function() {
    const items = [
      { id: {{ product.variants.first.id }}, quantity: 1 },
      {% for upsell_product in upsell_products limit: 1 %}
      { id: {{ upsell_product.variants.first.id }}, quantity: 1 }
      {% endfor %}
    ];

    bundleBtn.disabled = true;
    bundleBtn.textContent = 'Adding...';

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items })
    })
    .then(response => response.json())
    .then(data => {
      bundleBtn.textContent = 'Added!';
      setTimeout(() => {
        window.location.href = '/cart';
      }, 500);
    })
    .catch(error => {
      bundleBtn.disabled = false;
      bundleBtn.textContent = 'Add Both to Cart';
      console.error('Error:', error);
    });
  });
})();
</script>
{% endif %}
