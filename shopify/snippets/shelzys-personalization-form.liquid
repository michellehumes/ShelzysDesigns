{% comment %}
  Enhanced Personalization Form with Live Preview
  Installation: Replace default variant selector on product pages
{% endcomment %}

<style>
  .shelzy-personalization {
    margin: 20px 0;
  }

  .shelzy-personalization-group {
    margin-bottom: 20px;
  }

  .shelzy-personalization-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #4E5F4A;
    margin-bottom: 8px;
  }

  .shelzy-personalization-label small {
    font-weight: 400;
    color: #999;
  }

  .shelzy-personalization-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e5e5e5;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.2s;
    box-sizing: border-box;
  }

  .shelzy-personalization-input:focus {
    outline: none;
    border-color: #4E5F4A;
  }

  .shelzy-personalization-input.error {
    border-color: #dc2626;
  }

  .shelzy-char-count {
    font-size: 12px;
    color: #999;
    text-align: right;
    margin-top: 4px;
  }

  .shelzy-char-count.warning {
    color: #f59e0b;
  }

  .shelzy-char-count.error {
    color: #dc2626;
  }

  .shelzy-font-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  .shelzy-font-option {
    padding: 12px;
    border: 2px solid #e5e5e5;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .shelzy-font-option:hover {
    border-color: #ccc;
  }

  .shelzy-font-option.selected {
    border-color: #4E5F4A;
    background: #faf9f7;
  }

  .shelzy-font-option input {
    display: none;
  }

  .shelzy-font-preview {
    font-size: 18px;
    display: block;
    margin-bottom: 4px;
  }

  .shelzy-font-name {
    font-size: 11px;
    color: #666;
  }

  .font-script { font-family: 'Brush Script MT', cursive; }
  .font-serif { font-family: Georgia, serif; }
  .font-modern { font-family: 'Helvetica Neue', sans-serif; font-weight: 300; }

  .shelzy-color-selector {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .shelzy-color-option {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
    position: relative;
  }

  .shelzy-color-option:hover {
    transform: scale(1.1);
  }

  .shelzy-color-option.selected {
    border-color: #4E5F4A;
  }

  .shelzy-color-option.selected::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  .shelzy-color-option input {
    display: none;
  }

  /* Live Preview */
  .shelzy-preview {
    background: linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%);
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
  }

  .shelzy-preview-bottle {
    width: 120px;
    height: 200px;
    background: linear-gradient(180deg, #888 0%, #666 100%);
    border-radius: 12px 12px 40px 40px;
    margin: 0 auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .shelzy-preview-bottle::before {
    content: '';
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 20px;
    background: #555;
    border-radius: 4px 4px 0 0;
  }

  .shelzy-preview-text {
    font-size: 16px;
    max-width: 80px;
    word-wrap: break-word;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  .shelzy-preview-label {
    font-size: 12px;
    color: #666;
  }

  /* Multiple names for sets */
  .shelzy-names-list {
    margin-top: 10px;
  }

  .shelzy-names-list textarea {
    width: 100%;
    min-height: 100px;
    padding: 14px 16px;
    border: 2px solid #e5e5e5;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    box-sizing: border-box;
  }

  .shelzy-names-list textarea:focus {
    outline: none;
    border-color: #4E5F4A;
  }

  .shelzy-names-hint {
    font-size: 12px;
    color: #666;
    margin-top: 8px;
  }

  .shelzy-names-count {
    font-size: 13px;
    color: #4E5F4A;
    font-weight: 600;
    margin-top: 8px;
  }

  .shelzy-proof-request {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px;
    background: #f5f5f5;
    border-radius: 8px;
    margin-top: 20px;
  }

  .shelzy-proof-request input {
    width: 18px;
    height: 18px;
  }

  .shelzy-proof-request label {
    font-size: 14px;
    color: #333;
    cursor: pointer;
  }

  .shelzy-proof-request small {
    display: block;
    color: #666;
    font-size: 12px;
    margin-top: 2px;
  }
</style>

<div class="shelzy-personalization" id="personalizationForm">
  {% comment %} Single name or multiple based on product type {% endcomment %}
  {% if product.tags contains 'set' or product.title contains 'Set' %}
    <!-- Multiple Names Input -->
    <div class="shelzy-personalization-group">
      <label class="shelzy-personalization-label">
        Names to Personalize <small>(one per line)</small>
      </label>
      <div class="shelzy-names-list">
        <textarea
          name="properties[Names]"
          id="namesInput"
          placeholder="Sarah&#10;Emily&#10;Jessica&#10;Amanda&#10;Nicole&#10;Ashley"
          required
        ></textarea>
        <p class="shelzy-names-hint">Enter each name on a new line. We'll match the number of names to your quantity.</p>
        <p class="shelzy-names-count" id="namesCount">0 names entered</p>
      </div>
    </div>
  {% else %}
    <!-- Single Name Input -->
    <div class="shelzy-personalization-group">
      <label class="shelzy-personalization-label">
        Name to Print <small>(max 15 characters recommended)</small>
      </label>
      <input
        type="text"
        name="properties[Name]"
        id="nameInput"
        class="shelzy-personalization-input"
        maxlength="20"
        placeholder="Enter name here..."
        required
      >
      <p class="shelzy-char-count"><span id="charCount">0</span>/15 characters</p>
    </div>
  {% endif %}

  <!-- Font Selection -->
  <div class="shelzy-personalization-group">
    <label class="shelzy-personalization-label">Font Style</label>
    <div class="shelzy-font-selector">
      <label class="shelzy-font-option selected" data-font="script">
        <input type="radio" name="properties[Font]" value="Script" checked>
        <span class="shelzy-font-preview font-script">Abc</span>
        <span class="shelzy-font-name">Script</span>
      </label>
      <label class="shelzy-font-option" data-font="serif">
        <input type="radio" name="properties[Font]" value="Serif">
        <span class="shelzy-font-preview font-serif">Abc</span>
        <span class="shelzy-font-name">Classic</span>
      </label>
      <label class="shelzy-font-option" data-font="modern">
        <input type="radio" name="properties[Font]" value="Modern">
        <span class="shelzy-font-preview font-modern">Abc</span>
        <span class="shelzy-font-name">Modern</span>
      </label>
    </div>
  </div>

  <!-- Color Selection -->
  <div class="shelzy-personalization-group">
    <label class="shelzy-personalization-label">Text Color</label>
    <div class="shelzy-color-selector">
      <label class="shelzy-color-option selected" style="background: #ffffff; border: 1px solid #ddd;" data-color="#ffffff">
        <input type="radio" name="properties[Text Color]" value="White" checked>
      </label>
      <label class="shelzy-color-option" style="background: #000000;" data-color="#000000">
        <input type="radio" name="properties[Text Color]" value="Black">
      </label>
      <label class="shelzy-color-option" style="background: #d4af37;" data-color="#d4af37">
        <input type="radio" name="properties[Text Color]" value="Gold">
      </label>
      <label class="shelzy-color-option" style="background: #c0c0c0;" data-color="#c0c0c0">
        <input type="radio" name="properties[Text Color]" value="Silver">
      </label>
      <label class="shelzy-color-option" style="background: #ff69b4;" data-color="#ff69b4">
        <input type="radio" name="properties[Text Color]" value="Pink">
      </label>
      <label class="shelzy-color-option" style="background: #4E5F4A;" data-color="#4E5F4A">
        <input type="radio" name="properties[Text Color]" value="Brown">
      </label>
    </div>
  </div>

  <!-- Live Preview -->
  <div class="shelzy-preview">
    <p class="shelzy-preview-label">Preview</p>
    <div class="shelzy-preview-bottle">
      <span class="shelzy-preview-text font-script" id="previewText" style="color: #ffffff;">
        Your Name
      </span>
    </div>
  </div>

  <!-- Proof Request -->
  <div class="shelzy-proof-request">
    <input type="checkbox" name="properties[Request Proof]" id="proofRequest" value="Yes">
    <label for="proofRequest">
      Send me a design proof before production
      <small>We'll email a mockup for approval (adds 1 business day)</small>
    </label>
  </div>
</div>

<script>
(function() {
  const nameInput = document.getElementById('nameInput');
  const namesInput = document.getElementById('namesInput');
  const charCount = document.getElementById('charCount');
  const namesCount = document.getElementById('namesCount');
  const previewText = document.getElementById('previewText');
  const fontOptions = document.querySelectorAll('.shelzy-font-option');
  const colorOptions = document.querySelectorAll('.shelzy-color-option');

  // Single name input handler
  if (nameInput) {
    nameInput.addEventListener('input', function() {
      const length = this.value.length;
      charCount.textContent = length;

      // Update character count styling
      const countEl = charCount.parentElement;
      countEl.classList.remove('warning', 'error');
      if (length > 15) countEl.classList.add('warning');
      if (length > 18) countEl.classList.add('error');

      // Update preview
      previewText.textContent = this.value || 'Your Name';
    });
  }

  // Multiple names input handler
  if (namesInput) {
    namesInput.addEventListener('input', function() {
      const names = this.value.split('\n').filter(n => n.trim() !== '');
      namesCount.textContent = names.length + ' name' + (names.length !== 1 ? 's' : '') + ' entered';

      // Show first name in preview
      previewText.textContent = names[0] || 'Your Name';
    });
  }

  // Font selection
  fontOptions.forEach(option => {
    option.addEventListener('click', function() {
      fontOptions.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      this.querySelector('input').checked = true;

      // Update preview font
      const font = this.dataset.font;
      previewText.className = 'shelzy-preview-text font-' + font;
    });
  });

  // Color selection
  colorOptions.forEach(option => {
    option.addEventListener('click', function() {
      colorOptions.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      this.querySelector('input').checked = true;

      // Update preview color
      previewText.style.color = this.dataset.color;
    });
  });
})();
</script>
