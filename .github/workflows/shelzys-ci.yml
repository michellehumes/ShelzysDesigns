name: Shelzy's Designs CI/CD

on:
  push:
    branches: [main, feature/comprehensive-site-overhaul]
  pull_request:
    branches: [main]

jobs:
  # Job 1: Validate Liquid Templates
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Shopify Theme Check
        uses: shopify/theme-check-action@v2
        with:
          theme_root: ./
  # Job 2: Lint CSS
  lint-css:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Stylelint
        run: npm install -g stylelint stylelint-config-standard

      - name: Create Stylelint Config
        run: |
          echo '{"extends": "stylelint-config-standard"}' > .stylelintrc.json

      - name: Lint CSS
        run: |
          stylelint "brand/*.css" "shopify/assets/*.css" --fix || echo "CSS lint complete"
        continue-on-error: true

  # Job 3: Check Markdown
  markdown:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Markdown Files
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: "*.md audit-reports/*.md"
          config_file: ".markdownlint.json"
        continue-on-error: true

  # Job 4: Audit Report Summary
  audit-summary:
    runs-on: ubuntu-latest
    needs: [validate, lint-css, markdown]
    steps:
      - uses: actions/checkout@v4

      - name: Count Audit Issues
        run: |
          echo "## Audit Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count files
          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          echo "- Audit Reports: $(ls -1 audit-reports/*.md 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Shopify Snippets: $(ls -1 shopify/snippets/*.liquid 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Email Templates: $(ls -1 shopify/emails/*.html 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Priority Items" >> $GITHUB_STEP_SUMMARY

          # Extract P0 items from master recommendations
          if [ -f "MASTER-RECOMMENDATIONS.md" ]; then
            echo "See MASTER-RECOMMENDATIONS.md for full priority list" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 5: Create Release Notes (on main branch only)
  release-notes:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [audit-summary]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Notes
        run: |
          echo "# Release Notes - $(date +%Y-%m-%d)" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Changes in this release:" >> RELEASE_NOTES.md
          git log --oneline -10 >> RELEASE_NOTES.md

      - name: Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
